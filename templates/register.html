{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Create Account</h2>
    <div class="registration-wrapper">
        <div id="registration-form" class="form-section">
            <h3>Personal Information</h3>
            <div class="form-group">
                <label for="fullname">Full Name</label>
                <input type="text" id="fullname" placeholder="Enter your full name" required>
            </div>

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Choose a username" required>
                <small class="hint">Username must be unique and contain only letters, numbers, and underscores</small>
            </div>

            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="Enter your email" required>
            </div>

            <div class="form-group">
                <label for="dob">Date of Birth</label>
                <input type="date" id="dob" required>
            </div>

            <button onclick="sendOTP()" class="primary-btn">Continue & Send OTP</button>
        </div>

        <div id="otp-form" class="form-section" style="display: none;">
            <h3>Email Verification</h3>
            <div class="form-group">
                <label for="otp">Enter OTP</label>
                <input type="text" id="otp" placeholder="Enter 6-digit OTP" maxlength="6" required>
                <small class="hint">Please check your email for the OTP</small>
            </div>
            <div class="button-group">
                <button onclick="verifyOTP()" class="primary-btn">Verify OTP</button>
                <button onclick="resendOTP()" class="secondary-btn">Resend OTP</button>
            </div>
        </div>

        <div id="face-capture" class="form-section" style="display: none;">
            <h3>Face Authentication Setup</h3>
            <p class="instruction">Please position your face within the frame and ensure good lighting</p>
            <div class="video-container">
                <video id="video" width="640" height="480" autoplay></video>
                <canvas id="preview" width="640" height="480" style="display: none;"></canvas>
            </div>
            <div class="button-group">
                <button onclick="captureFace()" class="primary-btn">Capture Face</button>
                <button onclick="retakePhoto()" class="secondary-btn" style="display: none;">Retake Photo</button>
            </div>
        </div>
    </div>
</div>

<style>
.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.registration-wrapper {
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 30px;
}

h2 {
    text-align: center;
    color: #333;
    margin-bottom: 30px;
}

h3 {
    color: #444;
    margin-bottom: 20px;
}

.form-section {
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: 500;
}

input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    transition: border-color 0.3s;
}

input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}

.hint {
    display: block;
    color: #666;
    font-size: 12px;
    margin-top: 5px;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.primary-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}

.primary-btn:hover {
    background: #0056b3;
}

.secondary-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}

.secondary-btn:hover {
    background: #5a6268;
}

.instruction {
    color: #666;
    margin-bottom: 20px;
    text-align: center;
}

.video-container {
    position: relative;
    margin: 20px 0;
    text-align: center;
}

video, canvas {
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    max-width: 100%;
    height: auto;
}

/* Error state */
.error {
    border-color: #dc3545;
}

.error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: 5px;
}
</style>

<script>

async function sendOTP() {
    // Validate all fields
    const fullname = document.getElementById('fullname').value;
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const dob = document.getElementById('dob').value;

    if (!fullname || !username || !email || !dob) {
        alert('Please fill in all fields');
        return;
    }

    // Store form data in session storage for later use
    sessionStorage.setItem('registration_data', JSON.stringify({
        fullname,
        username,
        email,
        dob
    }));

    const response = await fetch('/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `email=${email}&fullname=${fullname}&username=${username}&dob=${dob}`
    });
    const data = await response.json();

    if (data.error) {
        alert(data.error);
    } else {
        document.getElementById('registration-form').style.display = 'none';
        document.getElementById('otp-form').style.display = 'block';
    }
}

async function verifyOTP() {
    const otp = document.getElementById('otp').value;
    const response = await fetch('/verify-otp', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `otp=${otp}`
    });
    const data = await response.json();

    if (data.success) {
        document.getElementById('otp-form').style.display = 'none';
        document.getElementById('face-capture').style.display = 'block';
        startVideo();
    } else {
        alert('Invalid OTP');
    }
}

async function resendOTP() {
    const registrationData = JSON.parse(sessionStorage.getItem('registration_data'));
    const response = await fetch('/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: `email=${registrationData.email}`
    });
    const data = await response.json();

    if (data.error) {
        alert(data.error);
    } else {
        alert('New OTP sent successfully');
    }
}

let video;
let preview;
let previewCtx;

async function startVideo() {
    video = document.getElementById('video');
    preview = document.getElementById('preview');
    previewCtx = preview.getContext('2d');

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    } catch (err) {
        alert('Error accessing camera: ' + err.message);
    }
}

async function captureFace() {
    const canvas = document.createElement('canvas');
    const retakeBtn = document.querySelector('.secondary-btn');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
    const formData = new FormData();
    formData.append('image', blob);

    try {
        const response = await fetch('/capture-face', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (data.success) {
            alert('Registration successful! Redirecting to login...');
            setTimeout(() => window.location.href = '/login', 1500);
        } else {
            alert(data.error);
            retakeBtn.style.display = 'block';
        }
    } catch (err) {
        alert('Error capturing face: ' + err.message);
        retakeBtn.style.display = 'block';
    }
}

function retakePhoto() {
    const retakeBtn = document.querySelector('.secondary-btn');
    retakeBtn.style.display = 'none';
    startVideo();
}
</script>
{% endblock %}